# SQL Server レプリケーションアーキテクチャ

このドキュメントでは、SQL Server トランザクションレプリケーションの技術的なアーキテクチャについて説明します。

## 目次
- [プッシュサブスクリプション](#プッシュサブスクリプション)
- [プルサブスクリプション](#プルサブスクリプション)
- [プッシュとプルの比較](#プッシュとプルの比較)
- [データベース構成](#データベース構成)

---

## プッシュサブスクリプション

### データフロー図

```
┌─────────────────────────────────────────────────────────────┐
│ 中央サーバー（Publisher）                                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ①業務データベース                                             │
│ ┌─────────────────┐                                         │
│ │ ReplicationDB   │ ← アプリケーションがデータ更新            │
│ │  - Products表   │                                         │
│ └────────┬────────┘                                         │
│          │トランザクションログに記録                           │
│          ▼                                                   │
│ ┌─────────────────┐                                         │
│ │ログファイル       │                                         │
│ └────────┬────────┘                                         │
│          │                                                   │
│          │②Log Reader Agentが監視・変更検知（常時動作）       │
│          ▼                                                   │
│ ┌─────────────────┐                                         │
│ │ distribution    │ ← レプリケーション管理データベース         │
│ │  - commands     │   変更内容を保存                         │
│ │  - transactions │                                         │
│ └────────┬────────┘                                         │
│          │                                                   │
│          │③Distribution Agent（Publisher側で動作）          │
│          │  定期的に変更をチェック（例: 5分間隔）             │
│          │  Subscriberへプッシュ配信                        │
│          ▼                                                   │
│ ┌───────────────────────────────────────────┐               │
│ │ Distribution Agent                        │               │
│ │  - スケジュール実行（5分間隔）             │               │
│ │  - distributionから変更を読み取り          │               │
│ │  - Subscriberに接続して変更を配信         │               │
│ └────────┬──────────────────────────────────┘               │
└──────────┼──────────────────────────────────────────────────┘
           │
           │ネットワーク接続（Publisher → Subscriber）
           │④変更を配信
           ▼
┌─────────────────────────────────────────────────────────────┐
│ 部門サーバー（Subscriber）                                     │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ┌─────────────────┐                                         │
│ │ ReplicationDB   │ ← 配信された変更を受信・適用             │
│ │  - Products表   │   （読み取り専用）                       │
│ └─────────────────┘                                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### レプリケーションの流れ

1. **データ更新（Publisher側）**
   ```sql
   INSERT INTO ReplicationDB.dbo.Products VALUES ('Tablet', 399.99);
   ```
   - ReplicationDBにデータ挿入
   - トランザクションログに自動記録

2. **Log Reader Agentが変更を検知**
   - 常時バックグラウンドで監視
   - トランザクションログを読み取り
   - distributionデータベースに書き込み
   - 頻度: リアルタイム（数秒以内）

3. **Distribution Agentが変更を配信**
   - 場所: **Publisher側で動作**
   - タイミング: 定期実行（例: 5分間隔）
   - 処理:
     1. distributionデータベースから未配信の変更を読み取り
     2. Subscriberに接続
     3. 変更をプッシュ配信

4. **Subscriberに変更を適用**
   - Distribution Agentから受信した変更を自動適用
   - トランザクションの順序性を保証

### 特徴と利点

**利点:**
- **中央集中管理**: Publisher側で全Subscriberの配信を制御
- **即時配信**: Distribution Agentが常時動作し、短い間隔で配信
- **シンプルな設定**: Subscriber側の設定が最小限
- **監視が容易**: Publisher側で全サブスクリプションの状態を一元管理

**適用シーン:**
- Subscriberが**常時稼働**している環境
- リアルタイム性が重要な場合
- 中央から複数拠点への一斉配信

---

## プルサブスクリプション

### データフロー図

```
┌─────────────────────────────────────────────────────────────┐
│ 中央サーバー（Publisher）                                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ①業務データベース                                             │
│ ┌─────────────────┐                                         │
│ │ ReplicationDB   │ ← アプリケーションがデータ更新            │
│ │  - Products表   │                                         │
│ └────────┬────────┘                                         │
│          │トランザクションログに記録                           │
│          ▼                                                   │
│ ┌─────────────────┐                                         │
│ │ログファイル       │                                         │
│ └────────┬────────┘                                         │
│          │                                                   │
│          │②Log Reader Agentが監視・変更検知（常時動作）       │
│          ▼                                                   │
│ ┌─────────────────┐                                         │
│ │ distribution    │ ← レプリケーション管理データベース         │
│ │  - commands     │   変更内容を一時保存                     │
│ │  - transactions │   保持期間: 72時間（デフォルト）          │
│ └────────┬────────┘                                         │
│          │                                                   │
│          │③Subscriberからの要求に応答                        │
│          │  「最後の同期以降の変更を返却」                     │
└──────────┼──────────────────────────────────────────────────┘
           │
           │ネットワーク接続（Subscriber → Publisher）
           │
┌──────────┼──────────────────────────────────────────────────┐
│          │部門サーバー（Subscriber）                          │
├──────────┴──────────────────────────────────────────────────┤
│                                                              │
│ ④Distribution Agent（Subscriber側で動作）                    │
│ ┌───────────────────────────────────────────┐               │
│ │ - スケジュール実行（例: 9:00～、30分間隔） │               │
│ │ - Publisherに接続して変更を要求           │               │
│ │ - 取得した変更を適用                      │               │
│ │ - 接続失敗時は次回リトライ                │               │
│ └────────┬──────────────────────────────────┘               │
│          │変更を適用                                         │
│          ▼                                                   │
│ ┌─────────────────┐                                         │
│ │ ReplicationDB   │ ← 同期されたデータ                       │
│ │  - Products表   │   （読み取り専用）                       │
│ └─────────────────┘                                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### レプリケーションの流れ

1. **データ更新（Publisher側）**
   ```sql
   INSERT INTO ReplicationDB.dbo.Products VALUES ('Tablet', 399.99);
   ```
   - ReplicationDBにデータ挿入
   - トランザクションログに自動記録

2. **Log Reader Agentが変更を検知**
   - 常時バックグラウンドで監視
   - トランザクションログを読み取り
   - distributionデータベースに書き込み
   - 頻度: リアルタイム（数秒以内）

3. **Subscriberから変更を要求**
   - 場所: **Subscriber側のDistribution Agent**
   - タイミング: 定期実行（例: 30分間隔）
   - 処理:
     1. Publisherのdistributionデータベースに接続
     2. 最後に同期したトランザクションID以降の変更を要求
     3. Publisherが該当する変更を返却

4. **Subscriberに変更を適用**
   - Distribution Agentが受け取った変更を自動実行
   - トランザクションの順序性を保証
   - 適用結果をログに記録

### 特徴と利点

**利点:**
- **分散制御**: 各Subscriberが独立して同期タイミングを制御
- **間欠稼働対応**: SubscriberがオフラインでもPublisherに影響なし
- **耐障害性**: 接続失敗時は次回自動リトライ
- **スケーラビリティ**: 複数Subscriberがそれぞれのペースで取得

**適用シーン:**
- Subscriberが**間欠的に稼働**する環境（夜間停止など）
- 部門サーバーが先に起動する可能性がある場合
- Publisher側の負荷を分散させたい場合

---

## プッシュとプルの比較

| 項目 | プッシュサブスクリプション | プルサブスクリプション |
|------|---------------------|----------------------|
| **Distribution Agent の場所** | Publisher側 | Subscriber側 |
| **接続方向** | Publisher → Subscriber | Subscriber → Publisher |
| **配信タイミング** | Publisher主導（5分間隔） | Subscriber主導（30分間隔） |
| **Subscriber停止時** | 配信エラーが発生 | 次回起動時に自動取得 |
| **起動順序依存** | Subscriberが先に起動不可 | どちらが先でも問題なし |
| **リアルタイム性** | 高い（短い間隔で配信） | 中程度（取得間隔に依存） |
| **Publisher負荷** | 高い（全配信を処理） | 低い（要求に応答するのみ） |
| **管理複雑度** | 低い（中央管理） | 中程度（各Subscriber設定） |

---

## データベース構成

### Publisher側（中央サーバー）

Publisherには**3つのデータベース**が存在します：

1. **ReplicationDB**（業務データベース）
   - 役割: アプリケーションが使用する実際の業務データを保持
   - 内容: レプリケーション対象のテーブル（例: Products表）
   - 特徴: トランザクションログがレプリケーションに使用される

2. **distribution**（ディストリビューションデータベース）
   - 役割: レプリケーションの変更を一時保存するキュー
   - 内容: 
     - commands テーブル: 実行するSQL文
     - transactions テーブル: トランザクション情報
   - 特徴: 
     - デフォルトで72時間保持
     - Log Reader Agentが書き込み
     - Distribution Agentが読み取り

3. **msdb**（システムデータベース）
   - 役割: SQL Server Agentのジョブ管理
   - 内容:
     - Log Reader Agentのジョブ定義
     - Distribution Agentのジョブ定義（プッシュの場合）
     - スケジュール情報

### Subscriber側（部門サーバー）

Subscriberには**2つのデータベース**が存在します：

1. **ReplicationDB**（同期されたデータベース）
   - 役割: Publisherから同期されたデータを保持
   - 内容: Publisherと同じ構造のテーブル（読み取り専用）
   - 特徴: Distribution Agentが変更を適用

2. **msdb**（システムデータベース）
   - 役割: SQL Server Agentのジョブ管理
   - 内容:
     - Distribution Agentのジョブ定義（プルの場合）
     - スケジュール情報

### データの流れ

```
[Publisher]
アプリケーション → ReplicationDB → トランザクションログ
                                      ↓
                              Log Reader Agent
                                      ↓
                              distribution DB
                                      ↓
                          Distribution Agent (場所は方式による)
                                      ↓
[Subscriber]
                              ReplicationDB
```
